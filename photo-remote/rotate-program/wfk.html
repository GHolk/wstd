<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="wfk.js"></script>
<style>
td {
    padding: 0.1em 0.3em;
}
table {
    border-left: solid 1px;
    border-right: solid 1px;
    border-radius: 0.5em;
    margin: 1em 0.8em;
}
form {
    position: fixed;
    right: 0;
    bottom: 0;
}
textarea {
    display: block;
    height: 30em;
    width: 30em;
}
</style>
<title> 旋轉矩陣計算 </title>
</head>
<body>

<p>
可以手動輸入或剪下貼上矩陣，
離開輸入框後會輸出計算的結在左側。
格式用空白或 tab 分隔。
</p>

<pre>
影像名稱1 繞X軸弧度 繞Y軸弧度 繞Z軸弧度 
影像名稱2 繞X軸弧度 繞Y軸弧度 繞Z軸弧度 
...       ...       ...       ...
</pre>

<p>
或直接由左下方選取 australis 輸出的 
<code>*_EOIO.txt</code> 。
</p>

<form>
<textarea placeholder="name &omega; &phi; &kappa;">
</textarea>
<input type="file">
</form>

<output></output>

<script>
(function(){
var board = document.getElementsByTagName('output')[0]

rotateWFK.Matrix3.prototype.toNode = function() {
    var table = document.createElement('table')
    var caption = document.createElement('caption')
    caption.textContent = this.name + '\n'
    table.appendChild(caption)

    this.reduce(function(table, row) {
        var tr = row.reduce(function(tr, cell) {
            var td = document.createElement('td')
            td.textContent = cell
            tr.appendChild(td)
            return tr
        }, document.createElement('tr'))
        table.appendChild(tr)
        return table
    }, table)

    return table
}

function parseEoioText(text) {
    text = text.replace(/\r/g,'')

    function truncatText(text) {
        var i = text.match(/omega\s*phi\s*kappa/i)
        if (i) text = text.slice(i.index).replace(/^.*?\n/,'')
        var j = text.indexOf('\n\n')
        if (j != -1) text = text.slice(0,j)
        return text
    }

    function parseToLines(text) {
        var wfkLines = text.split(/\n/g).map(function(line) {
            return line.split(/\s+/g)
        })
        return wfkLines.map(function(line) {
            /* input line end with name, omega, phi, kappa;
             * count from back.
             */
            var a = []
                for (var i=0; i<3; i++) {
                a.unshift(Number(line.pop()))
            }
            a.unshift(line.pop())
            return a
        })
    }

    var wfkLines = parseToLines(truncatText(text))
    window.wfkLines = wfkLines
    return wfkLines
}

function computeRotateMatrix(wfkLine) {
    wfk = wfkLine.slice(1)
    m = rotateWFK.rotateWFKMatrix.apply(this, wfk)
    m.name = wfkLine[0]
    m.wfk = wfk
    return m
}

function showMatrix(matrix) {
    board.appendChild(matrix.toNode())
}

function parseTextAndComputeMatrix(text) {
    board.textContent = ''
    parseEoioText(text)
        .map(computeRotateMatrix)
        .forEach(showMatrix)
}

document.getElementsByTagName('textarea')[0].addEventListener('change', function() {
    parseTextAndComputeMatrix(this.value)
})

document.getElementsByTagName('input')[0].addEventListener('change', function(evt) {
    var reader = new FileReader()
    reader.onload = function(evt) {
        parseTextAndComputeMatrix(evt.target.result)
    }
    reader.readAsText(this.files[0])
})
}())
</script>
</body>
</html>
